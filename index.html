<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="/cfg/config.js"></script>
    <script src="/test.js"></script>

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="/css/style.css"/>

    <title>Los Amigos MotU Convention</title>

    <link rel="manifest" href="/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('Service Worker registriert:', reg))
                .catch(err => console.log('Service Worker Registrierung fehlgeschlagen:', err));
        }
    </script>
    <style>
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }

        .button:hover {
            background-color: #0056b3;
        }


        #reader {
            position: relative;
            background-color: rgba(255,255,255,0.1);
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Scanbereich (Rahmen) */
        #reader__scan_region {
            width: auto !important;
            min-height: 150px;
            text-align: center;
            position: relative;
            border-radius: 10px;
            border: 5px dashed #007bff;
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Scan-Buttons */
        #html5-qrcode-button-camera-start, 
        #html5-qrcode-button-camera-stop {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }

        #html5-qrcode-button-camera-start:hover, 
        #html5-qrcode-button-camera-stop:hover {
            background-color: #0056b3;
        }

        /* Kamera-Auswahl Dropdown */
        #html5-qrcode-select-camera {
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #007bff;
            background-color: white;
            cursor: pointer;
        }

        /* Datei-Upload-Bereich */
        #html5-qrcode-private-filescan-input {
            display: none;
        }

        #html5-qrcode-button-file-selection {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
        }

        #html5-qrcode-button-file-selection:hover {
            background-color: #1e7e34;
        }

        /* Info-Bereich (zum Anzeigen von Statusmeldungen) */
        #reader__header_message {
            display: block;
            text-align: center;
            font-size: 14px;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 5px;
            background: #ffeb3b;
            color: #333;
            font-weight: bold;
        }

        /* Berechtigungen-Button */
        #html5-qrcode-button-camera-permission {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 18px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
            display: inline-block;
            margin: 10px auto;
        }
    </style>

</head>
<body>
    <div class="loading-overlay">
        <div style="color: white; font-size: 1.5rem;">Lädt...</div>
    </div>

    <div class="container">
        <header class="logo-header">            
            <svg alt="Vereinslogo" class="logo" width="100%" height="100%" version="1.1" viewBox="0 0 135.47 96.573" xmlns="http://www.w3.org/2000/svg">
              <g transform="translate(4.3487e-6,-180.85)">
               <g transform="matrix(.47799 0 0 .47799 -53.466 155.04)" stroke-width="2.0921">
                <path d="m179.4 235.93c0.89146-0.68697 1.0727-1.028 1.5486-2.5232 5.5265-13.27 8.8478-21.363 13.507-32.468 0.4471-1.1334 0.64439-1.0518 2.1428-1.5336 9.7344-3.6152 11.221-4.1772 21.493-7.9686 0.6726 0.12768 0.7633 1.2103 0.24947 2.9778-1.9438 7.8927-3.2228 13.172-4.3557 20.216-0.31202 1.855-0.33812 2.4096 1.496 1.2775 8.4126-4.6413 16.379-9.1701 24.522-13.668 1.2442-0.51307 1.2626-0.98439 1.2686-2.7416 1.0255-6.0785 1.6664-9.927 2.5757-14.991 0.52152-2.3886 0.72281-3.1094 2.1934-3.6463 6.8754-2.5754 12.913-4.8952 17.076-6.1599 1.5991-0.54354 1.8249 1.2435 2.0754 5.3904 0.0231 5.5074 4.2638 6.629 10.509 1.8776 5.014-3.6034 11.858-10.192 18.755-7.7268 1.6589 0.91359 3.6938 2.4655 4.5762 2.8646 1.6711 0.87508 2.3036-1.0641 0.74377-4.1193-1.2685-2.4844-1.6008-2.8096 2.228-5.1122 6.6954-4.5391 13.129-8.7127 17.919-11.532 7.3488-3.5246 11.538-5.4542 17.575-8.2439 11.274-4.722 25.138-9.8615 35.39-13.659 4.9843-2.0479 7.4231-3.1126 12.707-5.6096 2.892-1.8952 7.0801-4.5019 9.2954-6.7503 2.1288-3.8717-2.9476-4.834-17.469-2.3703-2.9134 0.35759-5.8376 1.5535-8.3705 2.2563-16.168 4.8954-23.004 6.9914-36.382 10.749-3.3937 0.9131-5.7727 1.451-8.4383 2.0845-3.9649 0.59027-10.137 1.5817-15.714 2.1091-5.0466 0.38482-19.556 0.88143-20.145 0.31714-0.0556-0.16694-0.14588-0.99956-0.28962-2.4702 0.44868-3.4432-2.4644-2.6253-4.3904 0.78735-1.3121 1.9347-2.1957 2.8982-4.1076 4.152-2.6309 1.5451-6.0216 1.5943-13.527 1.8195-9.4632 0.28398-14.548 3.1496-10.607 8.3996 2.8102 3.8958 3.5723 4.5776 1.6027 5.5711-5.5442 2.0409-8.8883 3.6858-8.0329 1.0941 5.7352-32.284 11.774-66.078 17.149-94.909 1.71-2.378 1.8719-2.8321 3.1526-4.6505 0.80084-1.5336-2e-3 -0.73556-0.93205-0.52344-16.768 4.6472-34.498 9.4506-48.911 13.901-1.9052 0.66572-1.8016 0.54628 2.2536 2.5354 2.7701 1.3588 2.8254 1.545 1.9046 3.5724-15.256 33.631-32.272 70.031-44.503 97.853-1.7075 3.7096-1.5838 3.5602-4.1512 4.6293-4.2624 1.172-7.5675 2.096-12.329 3.4736-2.4663 1.1991-2.4962 0.40892-1.1349-2.8206 15.67-41.674 32.27-85.546 46.932-124.26 0.31307-0.99183 0.31281-1.2956-0.51448-1.0859-13.301 3.5242-25.816 7.3827-37.744 10.622-2.5676 0.83397-5.4579 0.70865-1.3545 2.2216 4.0886 1.741 5.1209 1.8511 4.5126 3.4884-22.532 58.845-50.735 133.76-58.982 156.06-0.52009 1.4435-1.9398 3.5893-1.1902 4.1031 21.061-8.0711 32.899-12.272 46.539-17.563 0.45744-0.14552 0.91459-0.38151 1.259-0.13094 0.3157 0.46772 0.42586 0.6041-0.71159 2.8242-6.0693 13.477-12.108 27.004-17.467 38.706-0.74461 1.2213-0.45358 1.6625 0.38187 1.2818 13.274-7.2144 25.917-14.122 36.22-19.974zm91.094-58.117c-2.9961-1.0686-2.8829-6.0954-0.19099-8.5315 2.3931-2.7167 4.7132-3.0771 6.4009-3.5105 3.7607-1.1785 13.607-0.59593 16.425 1.7711 0.62886 1.3784-0.63345 1.1873-1.815 1.3326-2.2026 0.61697-3.6364 1.4329-6.0999 2.7874-4.1515 2.3451-6.3041 3.3407-9.9398 5.5368-2.4149 1.2426-3.0594 1.2279-4.78 0.61426zm-62.413-8.4074c-0.4396-0.40487 0.63487-1.9572 1.1966-2.8007 9.1894-21.992 18.238-43.259 26.999-64.213 0.43478-0.8035 0.58174-1.3391 0.92233-1.222 0.3693 0.10161 0.22144 0.64589 8e-3 2.0082-5.4654 24.836-8.2865 38.594-12.867 60.963-0.14644 1.1664-0.58149 1.1278-1.2896 1.2805-5.2421 1.4703-7.6619 2.2519-12.522 3.6476-1.479 0.37728-2.1457 0.63748-2.4466 0.33658zm57.913-14.779c-2.2872-1.1993-3.3367-2.1765-4.4597-3.2388-2.2485-3.6452 0.54147-6.1612 5.2852-6.1612 3.7697 0 14.944-2.0378 17.128-3.1884 2.1657-1.1411 2.4119-0.73102 1.8615 1.002-2.55 4.3236-3.9321 6.0696-7.6048 8.6736-3.9652 2.2556-8.5474 3.8376-12.21 2.9128z" stroke-width="2.0921"></path>
               </g>
              </g>
            </svg>
        </header>

        <main>
            <div class="content-card">
                <div id="content-display">


                </div>

                <div id="reader" class="mb-2">

                </div>
                <button class="button" id="startScanner">Scanner starten</button>
                <button class="button" id="stopScanner" style="display: none;">Scanner stoppen</button>

            </div>

            <div class="content-card">
                <h3 class="fw-bold">Dein Fortschritt</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div id="progress-text"></div>
            </div>

            <div class="content-card" >
                <h3 class="fw-bold">Deine Medaillen</h3>
                <div id="medals-display">

                </div>
            </div>

            <div class="content-card" >
                <h3 class="fw-bold">Künstler</h3>
                <div id="artists-display">

                </div>
            </div>

        </main>
    </div>

    <div class="modal-overlay" id="medal-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <img id="modal-image" class="medal-image" src="" alt="Medaille">
            <h3 class="fw-bold me-3" id="modal-title"></h3>
            <p><strong>Benötigte Codes:</strong> <span id="modal-required"></span></p>
            <p id="modal-description"></p>
        </div>
    </div>

    <script>
        let scanner;
        const startBtn = document.getElementById("startScanner");
        const stopBtn = document.getElementById("stopScanner");

        function onScanSuccess(decodedText, decodedResult) {
            try {
                const url = new URL(decodedText);

                stopScanner();
                
                window.location.href = url.toString();
                
            } catch (error) {
                console.error('Invalid URL in QR code:', error);
                showError('Ungültiger QR-Code');
            }
        }

        function onScanError(errorMessage) {
            //console.warn(`Scan-Fehler: ${errorMessage}`);
        }


        let config = {
            fps: 10,
            qrbox: {width: 100, height: 100},
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
            formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
        };

        function startScanner() {
            //scanner = new Html5QrcodeScanner("reader", config, false);
            //scanner.render(onScanSuccess, onScanError);

            scanner = new Html5Qrcode(
            "reader", { formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] });

            scanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);

            startBtn.style.display = "none";
            stopBtn.style.display = "inline-block";
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop();
                scanner = null;
            }
            startBtn.style.display = "inline-block";
            stopBtn.style.display = "none";
        }

        startBtn.addEventListener("click", startScanner);
        stopBtn.addEventListener("click", stopScanner);

    </script>

    <script>

        const WP_API_URL = CONFIG.WP_API_URL;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if(code) {
                await handleCodeParameter(code);
            } else {
                showDefaultContent();
            }
            
            fetchArtistsCount();
        });

        async function handleCodeParameter(code) {
            showLoading(true);
            
            try {
                if (!code || typeof code !== 'string') {
                    throw new Error('Ungültiger Code-Parameter');
                }

                let scannedCodes = [];
                try {
                    const storedCodes = localStorage.getItem('scannedCodes');
                    scannedCodes = storedCodes ? JSON.parse(storedCodes) : [];
                    
                    if (!Array.isArray(scannedCodes)) {
                        console.warn('Ungültiges gespeichertes Format, wird zurückgesetzt');
                        scannedCodes = [];
                    }

                } catch (storageError) {
                    console.error('Fehler beim Laden der Codes:', storageError);
                    scannedCodes = [];
                }


                const response = await fetch(
                    `${WP_API_URL}/artists?meta_key=code&meta_value=${encodeURIComponent(code)}&_fields=id,title,content`
                );

                console.log('API Antwort:', response);
                
                if (!response.ok) {
                    throw new Error(`HTTP Fehler! Status: ${response.status}`);
                }

                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error('Ungültiges Antwortformat von der API');
                }

                if (data.length === 0) {
                    showError('Ungültiger Künstler');
                    return;
                }

                const qrData = data[0];

                displayContent(qrData);
                
                try {
                    const scannedCodesSet = new Set(scannedCodes);
                    scannedCodesSet.add(code);
                    localStorage.setItem('scannedCodes', JSON.stringify([...scannedCodesSet]));

                } catch (storageError) {
                    console.error('Speicherfehler:', storageError);
                    showError('Fehler beim Speichern des Fortschritts');
                }

            } catch (error) {
                console.error('Kritischer Fehler:', error);
                showError(`Fehler: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }



        function displayContent(qrData) {
            const contentDiv = document.getElementById('content-display');
            contentDiv.innerHTML = `
                <h3 class="fw-bold">${qrData.title.rendered}</h3>
                <div>${qrData.content.rendered}</div>
            `;
        }

        function updateProgress(totalCodes) {
            const scannedCodes = JSON.parse(localStorage.getItem('scannedCodes') || '[]');
            const progress = (scannedCodes.length / totalCodes) * 100;
            
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${scannedCodes.length}/${totalCodes} Codes gescannt`;

            if (scannedCodes.length == totalCodes) {

                fireConfetti();

            }

            fetchMedals();
        }



        function showLoading(show) {
            document.querySelector('.loading-overlay').style.display = 
                show ? 'flex' : 'none';
        }

        function showError(message) {
            const contentDiv = document.getElementById('content-display');
            contentDiv.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function showDefaultContent() {
            const contentDiv = document.getElementById('content-display');
            contentDiv.innerHTML = `
                <h3 class="fw-bold">Willkommen bei der Los Amigos MotU Convention!</h3>
                <p>Scanne einen QR-Code um loszulegen.</p>
            `;
        }

        function showFinishContent() {
            const contentDiv = document.getElementById('content-display');
            contentDiv.innerHTML = `
                <h3 class="fw-bold">Willkommen bei der Los Amigos MotU Convention!</h3>
                <p>Du hast alle Künstler besucht. Sehr gut!</p>
            `;
        }
    

        async function fetchArtistsCount() {
            try {
                const response = await fetch(`${WP_API_URL}/artists-count`);
                if (!response.ok) {
                    throw new Error('Error fetching artists count');
                }
                const count = await response.json();
                updateProgress(count);
                fetchScannedArtists(); // Gescannte Künstler laden
            } catch(error) {
                console.error('Fehler beim Abrufen der Künstler:', error);
            }
        }

        async function fetchMedals() {
            try {
                const response = await fetch(`${WP_API_URL}/medals?acf_format=standard&_fields=id,title,acf`);
        
                if (!response.ok) { 
                    throw new Error(`HTTP Fehler! Status: ${response.status}`);
                }
                
                const allMedals = await response.json();
                
                let scannedCodes;
                try {
                    const storedCodes = localStorage.getItem('scannedCodes') || '[]';
                    scannedCodes = JSON.parse(storedCodes);
                    if (!Array.isArray(scannedCodes)) scannedCodes = [];
                } catch (e) {
                    console.error('Fehler beim Laden der Codes:', e);
                    scannedCodes = [];
                }
                
                const totalScanned = scannedCodes.length;

                const sortedMedals = allMedals.sort((a, b) => {
                    const reqA = parseInt(a.acf.required_codes) || 0;
                    const reqB = parseInt(b.acf.required_codes) || 0;
                    return reqA - reqB;
                });

                const medalsHTML = sortedMedals.map(medal => {
                    const required = parseInt(medal.acf.required_codes) || 0;
                    const isUnlocked = totalScanned >= required;
                    const remaining = required - totalScanned;
                    const codeWord = remaining === 1 ? 'Code' : 'Codes';
                    
                    return `
                        <div class="medal-item ${isUnlocked ? '' : 'locked'}" 
                            data-id="${medal.id}"
                            onclick="${isUnlocked ? `showMedalDetails(${medal.id})` : ''}">
                            ${isUnlocked ? 
                                `<img src="${medal.acf.medal_image}" class="medal-image" alt="${medal.title.rendered}">` :
                                '<div class="medal-image">🔒</div>'
                            }
                            ${isUnlocked ? `<div>${medal.title.rendered}</div>` : ''}                            
                            ${!isUnlocked ? `<small>Noch ${remaining} ${codeWord} benötigt</small>` : ''}
                        </div>
                    `;
                }).join('');

                document.getElementById('medals-display').innerHTML = `
                    <div class="medals-grid">${medalsHTML}</div>
                `;

            } catch (error) {
                console.error('Fehler beim Laden der Medaillen:', error);
                showError('Medaillen konnten nicht geladen werden');
            }
        }

        async function fetchScannedArtists() {
            try {
                const scannedCodes = JSON.parse(localStorage.getItem('scannedCodes') || '[]');
                if(scannedCodes.length === 0) {
                    document.getElementById('artists-display').innerHTML = '<p>Noch keine Künstler gescannt</p>';
                    return;
                }

                const response = await fetch(
                    `${WP_API_URL}/scanned-artists?codes=${encodeURIComponent(scannedCodes.join(','))}`
                );
                
                const artists = await response.json();
                displayArtists(artists);
                
            } catch(error) {
                console.error('Fehler beim Laden der Künstler:', error);
                document.getElementById('artists-display').innerHTML = 
                    '<p class="text-danger">Fehler beim Laden der Künstler</p>';
            }
        }



        function showMedalDetails(medalId) {
            fetch(`${WP_API_URL}/medals/${medalId}?acf_format=standard&_fields=id,title,acf`)
                .then(response => response.json())
                .then(medal => {
                    document.getElementById('modal-title').textContent = medal.title.rendered;
                    document.getElementById('modal-image').src = medal.acf.medal_image;
                    document.getElementById('modal-required').textContent = medal.acf.required_codes;
                    document.getElementById('modal-description').textContent = medal.acf.reward_description;
                    document.getElementById('medal-modal').style.display = 'flex';
                });
        }

        function closeModal() {
            document.getElementById('medal-modal').style.display = 'none';
        }

        document.getElementById('medal-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('medal-modal')) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });




        function displayArtists(artists) {
            let artistsHTML = '';
            
            for (let i = 0; i < artists.length; i++) {
                const artist = artists[i];
                artistsHTML += `
                    <div class="artist-item" data-artist='${JSON.stringify(artist).replace(/'/g, "\\'")}'>
                        <div>${artist.title}</div>
                    </div>
                `;
            }

            document.getElementById('artists-display').innerHTML = `
                <div class="artists-grid">${artistsHTML}</div>
            `;

            document.querySelectorAll('.artist-item').forEach(item => {
                item.addEventListener('click', () => {
                    const artistData = JSON.parse(item.dataset.artist);
                    showArtistDetails(artistData);
                });
            });
        }

        function showArtistDetails(artist) {    
            const modal = document.getElementById('medal-modal');
            modal.querySelector('#modal-title').innerHTML = artist.title;
            modal.querySelector('#modal-image').style.display = 'none';
            
            const requiredElement = modal.querySelector('#modal-required').parentElement;
            requiredElement.style.display = 'none';
            
            modal.querySelector('#modal-description').innerHTML = artist.content;
            modal.style.display = 'flex';
        }

        


        function fireConfetti() {
            console.log('Konfetti!');
            const count = 200;
            const defaults = {
                origin: { y: 0.7 }
            };

            function fire(particleRatio, opts) {
                confetti({
                    ...defaults,
                    ...opts,
                    particleCount: Math.floor(count * particleRatio)
                });
            }

            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
            
            confetti({
                particleCount: 100,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#FF6B35', '#004E89', '#FFE45E', '#2A9D8F']
            });
        }
    
    </script>
</body>
</html>